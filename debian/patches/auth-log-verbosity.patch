From 283322f493ee7dc75511f6cf9e9b88e536de0874 Mon Sep 17 00:00:00 2001
From: Colin Watson <cjwatson@debian.org>
Date: Sun, 9 Feb 2014 16:10:02 +0000
Subject: Quieten logs when multiple from= restrictions are used

Bug-Debian: http://bugs.debian.org/630606
Forwarded: no
Last-Update: 2013-09-14

Patch-Name: auth-log-verbosity.patch
---
 auth-options.c | 35 ++++++++++++++++++++++++++---------
 auth-options.h |  1 +
 auth2-pubkey.c |  3 +++
 4 files changed, 32 insertions(+), 9 deletions(-)

Index: openssh/auth2-pubkey.c
===================================================================
--- openssh.orig/auth2-pubkey.c
+++ openssh/auth2-pubkey.c
@@ -380,6 +380,7 @@ match_principals_file(struct ssh *ssh, s
 		restore_uid();
 		return 0;
 	}
+	auth_start_parse_options();
 	success = process_principals(ssh, f, file, cert, authoptsp);
 	fclose(f);
 	restore_uid();
@@ -710,6 +711,7 @@ check_authkeys_file(struct ssh *ssh, str
 	if (authoptsp != NULL)
 		*authoptsp = NULL;
 
+	auth_start_parse_options();
 	while (getline(&line, &linesize, f) != -1) {
 		linenum++;
 		/* Always consume entire file */
@@ -784,6 +786,7 @@ user_cert_trusted_ca(struct ssh *ssh, st
 	    use_authorized_principals ? NULL : pw->pw_name, &reason) != 0)
 		goto fail_reason;
 
+	auth_start_parse_options();
 	/* Check authority from options in key and from principals file/cmd */
 	if ((cert_opts = sshauthopt_from_cert(key)) == NULL) {
 		reason = "Invalid certificate options";
Index: openssh/auth.c
===================================================================
--- openssh.orig/auth.c
+++ openssh/auth.c
@@ -86,6 +86,17 @@ extern struct sshauthopt *auth_opts;
 /* Debugging messages */
 static struct sshbuf *auth_debug;
 
+/* Throttle log messages. */
+int logged_from_hostip = 0;
+int logged_cert_hostip = 0;
+
+void
+auth_start_parse_options(void)
+{
+	logged_from_hostip = 0;
+	logged_cert_hostip = 0;
+}
+
 /*
  * Check if the user is allowed to log in via ssh. If user is listed
  * in DenyUsers or one of user's groups is listed in DenyGroups, false
@@ -1154,11 +1165,14 @@ auth_authorise_keyopts(struct ssh *ssh,
 			auth_debug_add("%s: invalid from criteria", loc);
 			/* FALLTHROUGH */
 		case 0:
-			logit("%s: Authentication tried for %.100s with "
-			    "correct key but not from a permitted "
-			    "host (host=%.200s, ip=%.200s, required=%.200s).",
-			    loc, pw->pw_name, remote_host, remote_ip,
-			    opts->required_from_host_keys);
+			if (!logged_from_hostip) {
+				logit("%s: Authentication tried for %.100s with "
+				      "correct key but not from a permitted "
+				      "host (host=%.200s, ip=%.200s, required=%.200s).",
+				      loc, pw->pw_name, remote_host, remote_ip,
+				      opts->required_from_host_keys);
+				logged_from_hostip = 1;
+			}
 			auth_debug_add("%s: Your host '%.200s' is not "
 			    "permitted to use this key for login.",
 			    loc, remote_host);
@@ -1180,9 +1194,12 @@ auth_authorise_keyopts(struct ssh *ssh,
 			    loc);
 			/* FALLTHROUGH */
 		case 0:
-			logit("%s: Authentication tried for %.100s with valid "
-			    "certificate but not from a permitted source "
-			    "address (%.200s).", loc, pw->pw_name, remote_ip);
+			if (!logged_cert_hostip) {
+				logit("%s: Authentication tried for %.100s with valid "
+				      "certificate but not from a permitted source "
+				      "address (%.200s).", loc, pw->pw_name, remote_ip);
+				logged_cert_hostip = 1;
+			}
 			auth_debug_add("%s: Your address '%.200s' is not "
 			    "permitted to use this certificate for login.",
 			    loc, remote_ip);
Index: openssh/auth.h
===================================================================
--- openssh.orig/auth.h
+++ openssh/auth.h
@@ -221,6 +221,7 @@ void	 auth_restrict_session(struct ssh *
 int	 auth_authorise_keyopts(struct ssh *, struct passwd *pw,
     struct sshauthopt *, int, const char *);
 void	 auth_log_authopts(const char *, const struct sshauthopt *, int);
+void auth_start_parse_options(void);
 
 /* debug messages during authentication */
 void	 auth_debug_add(const char *fmt,...)
