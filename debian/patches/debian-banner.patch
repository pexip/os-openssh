From 9fcad888f4dbf0ecc0c7e87b6ef0f8d88d7ac3ec Mon Sep 17 00:00:00 2001
From: Kees Cook <kees@debian.org>
Date: Sun, 9 Feb 2014 16:10:06 +0000
Subject: Add DebianBanner server configuration option

Setting this to "no" causes sshd to omit the Debian revision from its
initial protocol handshake, for those scared by package-versioning.patch.

Bug-Debian: http://bugs.debian.org/562048
Forwarded: not-needed
Last-Update: 2013-09-14

Patch-Name: debian-banner.patch
---
 kex.c         | 5 +++--
 kex.h         | 2 +-
 servconf.c    | 9 +++++++++
 servconf.h    | 2 ++
 sshconnect.c  | 2 +-
 sshd.c        | 3 ++-
 sshd_config.5 | 5 +++++
 7 files changed, 23 insertions(+), 5 deletions(-)

Index: openssh/kex.c
===================================================================
--- openssh.orig/kex.c
+++ openssh/kex.c
@@ -1161,7 +1161,7 @@ kex_exchange_identification(struct ssh
  */
 int
 kex_exchange_identification(struct ssh *ssh, int timeout_ms,
-    const char *version_addendum)
+    int debian_banner, const char *version_addendum)
 {
 	int remote_major, remote_minor, mismatch;
 	size_t len, i, n;
@@ -1179,7 +1179,8 @@ kex_exchange_identification(struct ssh
 	if (version_addendum != NULL && *version_addendum == '\0')
 		version_addendum = NULL;
 	if ((r = sshbuf_putf(our_version, "SSH-%d.%d-%.100s%s%s\r\n",
-	   PROTOCOL_MAJOR_2, PROTOCOL_MINOR_2, SSH_RELEASE,
+	   PROTOCOL_MAJOR_2, PROTOCOL_MINOR_2,
+	   debian_banner ? SSH_RELEASE : SSH_RELEASE_MINIMUM,
 	    version_addendum == NULL ? "" : " ",
 	    version_addendum == NULL ? "" : version_addendum)) != 0) {
 		error("%s: sshbuf_putf: %s", __func__, ssh_err(r));
Index: openssh/kex.h
--- openssh.orig/kex.h
+++ openssh/kex.h
@@ -177,7 +177,7 @@
 char	*kex_names_cat(const char *, const char *);
 int	 kex_assemble_names(char **, const char *, const char *);
 
-int	 kex_exchange_identification(struct ssh *, int, const char *);
+int	 kex_exchange_identification(struct ssh *, int, int, const char *);
 
 struct kex *kex_new(void);
 int	 kex_ready(struct ssh *, char *[PROPOSAL_MAX]);
Index: openssh/servconf.c
===================================================================
--- openssh.orig/servconf.c
+++ openssh/servconf.c
@@ -180,6 +180,7 @@ initialize_server_options(ServerOptions
 	options->fingerprint_hash = -1;
 	options->disable_forwarding = -1;
 	options->expose_userauth_info = -1;
+	options->debian_banner = -1;
 }
 
 /* Returns 1 if a string option is unset or set to "none" or 0 otherwise. */
@@ -411,6 +412,8 @@ fill_default_server_options(ServerOption
 		options->disable_forwarding = 0;
 	if (options->expose_userauth_info == -1)
 		options->expose_userauth_info = 0;
+	if (options->debian_banner == -1)
+		options->debian_banner = 1;
 
 	assemble_algorithms(options);
 
@@ -496,7 +499,7 @@ typedef enum {
 	sAuthenticationMethods, sHostKeyAgent, sPermitUserRC,
 	sStreamLocalBindMask, sStreamLocalBindUnlink,
 	sAllowStreamLocalForwarding, sFingerprintHash, sDisableForwarding,
-	sExposeAuthInfo, sRDomain,
+	sExposeAuthInfo, sRDomain, sDebianBanner,
 	sDeprecated, sIgnore, sUnsupported
 } ServerOpCodes;
 
@@ -646,6 +649,7 @@ static struct {
 	{ "exposeauthinfo", sExposeAuthInfo, SSHCFG_ALL },
 	{ "rdomain", sRDomain, SSHCFG_ALL },
 	{ "casignaturealgorithms", sCASignatureAlgorithms, SSHCFG_ALL },
+	{ "debianbanner", sDebianBanner, SSHCFG_GLOBAL },
 	{ NULL, sBadOption, 0 }
 };
 
@@ -2150,6 +2154,10 @@ process_server_config_line(ServerOptions
 			*charptr = xstrdup(arg);
 		break;
 
+	case sDebianBanner:
+		intptr = &options->debian_banner;
+		goto parse_int;
+
 	case sDeprecated:
 	case sIgnore:
 	case sUnsupported:
Index: openssh/servconf.h
===================================================================
--- openssh.orig/servconf.h
+++ openssh/servconf.h
@@ -210,6 +210,8 @@ typedef struct {
 	int	fingerprint_hash;
 	int	expose_userauth_info;
 	u_int64_t timing_secret;
+
+	int	debian_banner;
 }       ServerOptions;
 
 /* Information about the incoming connection as used by Match */
Index: openssh/sshconnect.c
--- openssh.orig/sshconnect.c
+++ openssh/sshconnect.c
@@ -1284,7 +1284,7 @@ ssh_login (struct ssh *ssh, Sensitive
 	lowercase(host);
 
 	/* Exchange protocol version identification strings with the server. */
-	if (kex_exchange_identification(ssh, timeout_ms, NULL) != 0)
+	if (kex_exchange_identification(ssh, timeout_ms, 0, NULL) != 0)
 		cleanup_exit(255); /* error already logged */
 
 	/* Put the connection into non-blocking mode. */
Index: openssh/sshd.c
--- openssh.orig/sshd.c
+++ openssh/sshd.c
@@ -2081,7 +2081,8 @@ main(int ac, char **av)
 	if (!debug_flag)
 		alarm(options.login_grace_time);
 
-	if (kex_exchange_identification(ssh, -1, options.version_addendum) != 0)
+	if (kex_exchange_identification(ssh, -1, options.debian_banner,
+	    options.version_addendum) != 0)
 		cleanup_exit(255); /* error already logged */
 
 	ssh_packet_set_nonblocking(ssh);
Index: openssh/sshd_config.5
===================================================================
--- openssh.orig/sshd_config.5
+++ openssh/sshd_config.5
@@ -543,6 +543,11 @@ or
 .Cm no .
 The default is
 .Cm yes .
+.It Cm DebianBanner
+Specifies whether the distribution-specified extra version suffix is
+included during initial protocol handshake.
+The default is
+.Cm yes .
 .It Cm DenyGroups
 This keyword can be followed by a list of group name patterns, separated
 by spaces.
